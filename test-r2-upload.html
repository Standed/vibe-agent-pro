<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R2 ä¸Šä¼ æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f23;
      color: #e0e0e0;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: #9d4edd;
      margin-bottom: 30px;
      text-align: center;
    }

    .test-section {
      background: #1a1a2e;
      border: 1px solid #2a2a3e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .test-section h2 {
      color: #c77dff;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .file-input-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    input[type="file"] {
      flex: 1;
      padding: 8px;
      background: #0f0f23;
      border: 1px solid #2a2a3e;
      border-radius: 4px;
      color: #e0e0e0;
      cursor: pointer;
    }

    button {
      padding: 10px 20px;
      background: #9d4edd;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:hover {
      background: #c77dff;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 14px;
    }

    .status.loading {
      background: #1e3a5f;
      color: #64b5f6;
    }

    .status.success {
      background: #1b5e20;
      color: #81c784;
    }

    .status.error {
      background: #5f1e1e;
      color: #ef5350;
    }

    .result {
      margin-top: 15px;
      padding: 10px;
      background: #0f0f23;
      border: 1px solid #2a2a3e;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
    }

    .preview {
      margin-top: 15px;
      max-width: 100%;
    }

    .preview img,
    .preview video,
    .preview audio {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #2a2a3e;
    }

    .info {
      background: #1e3a5f;
      color: #64b5f6;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .info strong {
      color: #90caf9;
    }

    code {
      background: #2a2a3e;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Cloudflare R2 ä¸Šä¼ æµ‹è¯•</h1>

    <div class="info">
      <strong>âš ï¸ æµ‹è¯•å‰æï¼š</strong><br>
      1. ç¡®ä¿å·²å¯åŠ¨ Next.js å¼€å‘æœåŠ¡å™¨ï¼š<code>npm run dev</code><br>
      2. ç¡®ä¿å·²ç™»å½•ç³»ç»Ÿï¼ˆéœ€è¦ Authorization tokenï¼‰<br>
      3. ç¡®ä¿ .env.local ä¸­é…ç½®äº†æ­£ç¡®çš„ R2 å‡­è¯
    </div>

    <!-- å›¾ç‰‡ä¸Šä¼ æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ“· å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</h2>
      <div class="file-input-wrapper">
        <input type="file" id="imageFile" accept="image/*">
        <button onclick="testImageUpload()">ä¸Šä¼ å›¾ç‰‡</button>
      </div>
      <div id="imageStatus"></div>
      <div id="imageResult"></div>
      <div id="imagePreview" class="preview"></div>
    </div>

    <!-- è§†é¢‘ä¸Šä¼ æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ¬ è§†é¢‘ä¸Šä¼ æµ‹è¯•</h2>
      <div class="file-input-wrapper">
        <input type="file" id="videoFile" accept="video/*">
        <button onclick="testVideoUpload()">ä¸Šä¼ è§†é¢‘</button>
      </div>
      <div id="videoStatus"></div>
      <div id="videoResult"></div>
      <div id="videoPreview" class="preview"></div>
    </div>

    <!-- éŸ³é¢‘ä¸Šä¼ æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸµ éŸ³é¢‘ä¸Šä¼ æµ‹è¯•</h2>
      <div class="file-input-wrapper">
        <input type="file" id="audioFile" accept="audio/*">
        <button onclick="testAudioUpload()">ä¸Šä¼ éŸ³é¢‘</button>
      </div>
      <div id="audioStatus"></div>
      <div id="audioResult"></div>
      <div id="audioPreview" class="preview"></div>
    </div>
  </div>

  <script>
    // ä» cookie è¯»å– session token
    function getSessionToken() {
      const match = document.cookie.match(/supabase-session=([^;]+)/);
      if (!match) {
        return null;
      }
      try {
        const decoded = decodeURIComponent(match[1]);
        const session = JSON.parse(decoded);
        return session.access_token;
      } catch (e) {
        console.error('Failed to parse session:', e);
        return null;
      }
    }

    // é€šç”¨ä¸Šä¼ å‡½æ•°
    async function uploadToR2(file, folder, statusId, resultId, previewId) {
      const statusEl = document.getElementById(statusId);
      const resultEl = document.getElementById(resultId);
      const previewEl = document.getElementById(previewId);

      if (!file) {
        statusEl.className = 'status error';
        statusEl.textContent = 'âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶';
        return;
      }

      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      const token = getSessionToken();
      if (!token) {
        statusEl.className = 'status error';
        statusEl.textContent = 'âŒ æœªç™»å½•ï¼Œè¯·å…ˆåœ¨ä¸»åº”ç”¨ä¸­ç™»å½•';
        return;
      }

      statusEl.className = 'status loading';
      statusEl.textContent = 'â³ ä¸Šä¼ ä¸­...';
      resultEl.innerHTML = '';
      previewEl.innerHTML = '';

      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('folder', folder);
        // userId ä¼šä» Authorization token ä¸­è‡ªåŠ¨è§£æ

        const startTime = Date.now();
        const response = await fetch('http://localhost:3001/api/upload-r2', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error);
        }

        const result = await response.json();

        statusEl.className = 'status success';
        statusEl.textContent = `âœ… ä¸Šä¼ æˆåŠŸï¼è€—æ—¶: ${elapsed}s`;

        resultEl.className = 'result';
        resultEl.innerHTML = `
          <strong>ä¸Šä¼ ç»“æœï¼š</strong><br>
          URL: <a href="${result.url}" target="_blank" style="color: #90caf9;">${result.url}</a><br>
          Key: ${result.key}<br>
          Bucket: ${result.bucket}<br>
          Request ID: ${result.requestId}
        `;

        // æ˜¾ç¤ºé¢„è§ˆ
        if (file.type.startsWith('image/')) {
          previewEl.innerHTML = `<img src="${result.url}" alt="Preview">`;
        } else if (file.type.startsWith('video/')) {
          previewEl.innerHTML = `<video src="${result.url}" controls></video>`;
        } else if (file.type.startsWith('audio/')) {
          previewEl.innerHTML = `<audio src="${result.url}" controls></audio>`;
        }

      } catch (error) {
        statusEl.className = 'status error';
        statusEl.textContent = `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`;
        console.error('Upload error:', error);
      }
    }

    // æµ‹è¯•å‡½æ•°
    function testImageUpload() {
      const file = document.getElementById('imageFile').files[0];
      uploadToR2(file, 'test-images', 'imageStatus', 'imageResult', 'imagePreview');
    }

    function testVideoUpload() {
      const file = document.getElementById('videoFile').files[0];
      uploadToR2(file, 'test-videos', 'videoStatus', 'videoResult', 'videoPreview');
    }

    function testAudioUpload() {
      const file = document.getElementById('audioFile').files[0];
      uploadToR2(file, 'test-audios', 'audioStatus', 'audioResult', 'audioPreview');
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.onload = function() {
      const token = getSessionToken();
      if (!token) {
        const info = document.querySelector('.info');
        info.style.background = '#5f1e1e';
        info.style.color = '#ef5350';
        info.innerHTML = '<strong>âš ï¸ æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼</strong><br>è¯·å…ˆè®¿é—® <a href="http://localhost:3001" style="color: #90caf9;">http://localhost:3001</a> å¹¶ç™»å½•ï¼Œç„¶ååˆ·æ–°æ­¤é¡µé¢ã€‚';
      } else {
        const info = document.querySelector('.info');
        info.style.background = '#1b5e20';
        info.style.color = '#81c784';
        info.innerHTML = '<strong>âœ… å·²æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€</strong><br>å¯ä»¥å¼€å§‹æµ‹è¯•ä¸Šä¼ åŠŸèƒ½ã€‚';
      }
    };
  </script>
</body>
</html>
