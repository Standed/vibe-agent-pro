# 设计方案 v3 借鉴要点沉淀（基于现有代码）

> **目的**：客观看 v3 的内容，筛出“可借鉴且不颠覆现有架构”的点，并落为可执行的设计指引  
> **依据**：`docs/design-proposal-v3.md` + 现有代码（`LeftSidebarNew` / `DirectorMode` / `InfiniteCanvas` / `ChatPanel`）+ `supabase/schema.sql`  
> **日期**：2025-12-31

---

## 1. 可直接借鉴（不改架构即可落地）

### 1.1 明确产品定位表达
- **愿景表达**可沿用：“像 Medeo 一样靠聊天创作，像 Seko 2.0 一样资产可控”  
- **目标用户**的描述清晰可用（10 分钟以上叙事视频的个人/小团队）

### 1.2 三段式主流程（首页 -> 策划 -> 画布）
- v3 的三段式流程符合我们当前结构与导航  
- **关键要点可直接采纳**：
  - 首页：灵感输入为主 CTA  
  - 策划页：左资产 + 右 Agent 对话  
  - 画布页：中画布 + 右聊天（Agent/Pro 切换）

### 1.3 策划页左右分栏布局
v3 的布局与现有 `DirectorMode` 方向一致，资产编辑逻辑也能承接当前 `Character/Location` 资产结构。  
建议保留以下结构：
- 左侧：剧本 / 角色 / 场景 / 分镜脚本  
- 右侧：Agent 多轮对话 + 进度提示  
- “进入画布”作为阶段性确认按钮

### 1.4 画布页三栏结构
v3 的“左图标栏 + 中画布 + 右对话”与现有布局一致，**可直接写成 UI 规范**：
- 左侧 48px 图标栏（可点开）  
- 中央：按场景分组的分镜缩略图  
- 右侧：Agent/Pro 切换聊天

### 1.5 学习成本策略
v3 提出的“5 分钟路径”适合做新手引导：
- 灵感 -> Agent 生成资产 -> 进入画布 -> 一键批量生成 -> Pro 微调  
可直接作为 onboarding 文案与产品引导流程参考。

---

## 2. 需要对齐现有代码的点（避免误导）

### 2.1 项目脚本字段（script）
v3 建议新增 `projects.script` JSONB，但现有实现是：
- **写入**：`projects.metadata.script`  
- **读取**：`dataService.loadProject()` 从 `metadata.script` 读取

**结论**：短期不要改 schema，保持 metadata 存储，避免数据迁移成本。

### 2.2 分镜血缘字段（parent_image_id / reference_ids）
v3 计划新增字段，但现有结构已有：
- `shots.generation_history` 可作为血缘基础  
- `chat_messages.metadata.images` 可做引用追溯

**结论**：短期先通过 metadata/历史记录表达血缘，不需要立即改表结构。

### 2.3 分镜详情展示位置
v3 画布示意里是“底部详情面板”，但现有实现主要是：
- 侧边栏进入 `ShotEditor`（全屏/弹层）  
- `ShotDetailPanel` 目前未接入主流程

**结论**：保持现有“弹层/侧边栏详情”，不要强行改为底部面板。

---

## 3. 可借鉴但建议后置（P1/P2）

### 3.1 Pro 多 Track 交互
v3 的 Track A/B 切换逻辑与 `docs/ChatGPT-history.md` 一致，但目前代码无 track 数据结构。  
**建议**：先定义交互规范，数据层暂不落库。

### 3.2 斜杠命令体系
v3 的 `/generate-all`、`/style`、`/analyze` 具有价值，但当前 UI 未实现 Slash 命令解析。  
**建议**：先把 Agent/Pro 指令写成快捷按钮，后续再统一为 Slash。

### 3.3 公共工作流 / ComfyUI / RunningHub
v3 将其放在 Phase 3 是合理的；现阶段先确保“策划 -> 画布 -> 生成”的闭环。

---

## 4. 与现有模块的直接映射（便于落地）

| 设计要点 | 现有模块 | 说明 |
|---------|----------|------|
| 策划页剧本编辑 | `DirectorMode` | 剧本输入 + 资产编辑已具备雏形 |
| 分镜脚本表格 | `ShotTableEditor` | 可作为策划页分镜脚本编辑入口 |
| 画布分镜区 | `InfiniteCanvas` | 已按场景组织，可继续优化交互 |
| 右侧对话 | `RightPanel` + `ChatPanel` | 已支持 Agent/Pro 切换 |
| 聊天记录分层 | `chat_messages` | 项目/场景/分镜三层对话已存在 |

---

## 5. 可纳入的精简共识（供团队对齐）

1. **MVP 只做三段式流程闭环**：策划 -> 画布 -> 生成  
2. **对话为主，Pro 为辅**：Agent 处理批量，Pro 处理细节  
3. **自由画布先放草稿模式**：主画布保持结构化  
4. **一致性双模式用资产级 Tab**：避免混淆用户心智
