# Video Agent Pro - 架构评估报告

> **评估日期**: 2026-01-19  
> **版本**: v3.0  
> **目标**: 评估当前架构能否支撑一期（10人并发）、二期（100+用户）及未来 C 端产品目标

---

## 📋 目录

1. [当前架构概览](#当前架构概览)
2. [架构优势](#架构优势)
3. [潜在瓶颈与风险](#潜在瓶颈与风险)
4. [阶段性评估](#阶段性评估)
5. [验证清单](#验证清单)
6. [优化路径建议](#优化路径建议)
7. [验证记录](#验证记录)

---

## 当前架构概览

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端** | Next.js 15.1 + React 19 | App Router + Turbopack |
| **状态管理** | Zustand + Immer | 客户端状态，无跨设备同步 |
| **部署** | Vercel Serverless | 每个 API 请求独立实例 |
| **数据库** | Supabase PostgreSQL | 托管服务，支持实时订阅 |
| **文件存储** | Cloudflare R2 | S3 兼容，零出口费用 |
| **认证** | Supabase Auth | JWT + Session |

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户浏览器 (React)                         │
│                  Zustand 本地状态管理                         │
│              ┌─────────────────────────┐                     │
│              │   useProjectStore       │                     │
│              │   (项目状态 + 800ms防抖) │                     │
│              └─────────────────────────┘                     │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTPS
┌──────────────────────────▼──────────────────────────────────┐
│               Vercel Serverless Functions                    │
│           (Next.js API Routes, 每个请求独立实例)              │
│                                                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────────────┐     │
│  │ /api/agent │  │/api/sora/* │  │ /api/gemini-*      │     │
│  │ AI 对话    │  │ 视频生成   │  │ 图片生成           │     │
│  └────────────┘  └────────────┘  └────────────────────┘     │
│                                                              │
│  ⚠️ 执行时间限制: Hobby=10s, Pro=60s                         │
└──────────────────────────┬──────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
   ┌──────────┐      ┌──────────┐      ┌──────────┐
   │ Supabase │      │Cloudflare│      │ 第三方AI  │
   │PostgreSQL│      │    R2    │      │   API    │
   │  + Auth  │      │ (媒体)   │      │          │
   └──────────┘      └──────────┘      └──────────┘
                                             │
                           ┌─────────────────┼─────────────────┐
                           ▼                 ▼                 ▼
                    ┌──────────┐      ┌──────────┐      ┌──────────┐
                    │ Gemini   │      │  Sora    │      │ 火山引擎  │
                    │ (Google) │      │(Kaponai) │      │SeeDream等│
                    └──────────┘      └──────────┘      └──────────┘
```

### 核心数据流

```
用户操作 → Zustand Store → 800ms 防抖 → dataService → API Route → Supabase
                                                              ↓
                                                         PostgreSQL
```

---

## 架构优势

### ✅ 可扩展的基础设施

| 组件 | 评价 | 说明 |
|------|------|------|
| **Vercel CDN** | ⭐⭐⭐⭐⭐ | 全球边缘网络，自动扩展，零配置 |
| **Supabase PostgreSQL** | ⭐⭐⭐⭐ | 托管服务，自动备份，Pro 版可支撑数千用户 |
| **Cloudflare R2** | ⭐⭐⭐⭐⭐ | 零出口费用，无限带宽，S3 兼容 |
| **Supabase Auth** | ⭐⭐⭐⭐ | 完善的认证系统，支持 OAuth、MFA |

### ✅ 良好的代码结构

| 方面 | 评价 | 说明 |
|------|------|------|
| **类型安全** | ⭐⭐⭐⭐ | TypeScript 严格模式，类型定义完善 |
| **统一数据层** | ⭐⭐⭐⭐⭐ | `dataService.ts` 封装所有 CRUD，迁移成本低 |
| **服务分离** | ⭐⭐⭐⭐ | 各 AI 服务独立文件，易于替换和扩展 |
| **工具模块化** | ⭐⭐⭐⭐ | 28 个 Agent 工具独立定义，易于新增 |

### ✅ 成本优化设计

| 决策 | 效果 |
|------|------|
| Supabase 只存 URL，不存媒体文件 | 数据库容量省 90%+ |
| R2 零出口费用 | 视频预览不产生额外成本 |
| Serverless 按需计费 | 无空闲成本 |
| 积分系统控制 AI 调用 | 防止滥用 |

---

## 潜在瓶颈与风险

### 🔴 高风险

#### 1. Vercel Serverless 执行时间限制

**问题描述**：
- Hobby 版: **10 秒** 超时
- Pro 版: **60 秒** 超时
- Sora 视频生成需要 **数分钟**

**当前解决方案**：
```typescript
// SoraOrchestrator 提交任务后立即返回，不等待完成
const taskId = await kaponaiService.submitTask(...);
await dataService.saveSoraTask({ id: taskId, status: 'processing' });
return taskId; // 立即返回

// 客户端通过 useSoraTaskManager 轮询状态
```

**风险**：
- ✅ 当前设计**已规避**此问题
- ⚠️ 但如果用户关闭浏览器，任务状态同步可能延迟

**验证方法**：
- [ ] 测试提交 Sora 任务后立即关闭浏览器，重新打开后任务状态是否正确

---

#### 2. 无独立任务队列

**问题描述**：
- 没有 Redis/Bull 等消息队列
- 10 人同时触发批量生成，会直接冲击第三方 API
- 没有任务优先级和排队机制

**影响范围**：
```
1-5 人并发 → 可能无感知
5-10 人并发 → 可能遇到 API 限流
10+ 人并发 → 高概率失败
```

**验证方法**：
- [ ] 5 人同时触发 `batchGenerateProjectImages`，观察成功率
- [ ] 5 人同时触发 `batchGenerateProjectVideosSora`，观察成功率

**二期解决方案**：引入 Cloudflare Queues 或 Upstash Redis

---

#### 3. 第三方 API 并发限制

| API | 预估限制 | 风险等级 | 验证状态 |
|-----|----------|----------|----------|
| **Gemini API** | 60 QPM (免费) | 🟡 中等 | [ ] 待验证 |
| **Kaponai (Sora)** | 未知 | 🔴 高 | [ ] 待验证 |
| **火山引擎 SeeDream** | 账号 QPS | 🟡 中等 | [ ] 待验证 |
| **火山引擎 SeeDance** | 账号 QPS | 🟡 中等 | [ ] 待验证 |
| **即梦 Jimeng** | 未知 | 🟡 中等 | [ ] 待验证 |

**验证方法**：
- [ ] 记录每个 API 的 429 错误频率
- [ ] 联系 Kaponai 确认并发限制

---

### 🟡 中风险

#### 4. 实时协作缺失

**问题描述**：
- 多人编辑同一项目会**覆盖数据**
- 没有 WebSocket 实时同步
- 仅靠 Supabase Realtime 做任务状态订阅

**当前状态**：
- 一期（各自做不同项目）→ **无影响**
- 二期（团队协作）→ **需要评估**

**验证方法**：
- [ ] 两人同时编辑同一项目，观察数据覆盖情况

---

#### 5. 大项目性能

**问题描述**：
- `useProjectStore` 加载整个项目到内存
- 100+ 镜头的项目可能造成内存压力
- 无分页加载机制

**验证方法**：
- [ ] 创建 100 镜头项目，测量加载时间
- [ ] 创建 200 镜头项目，测量加载时间和内存占用
- [ ] 观察浏览器是否卡顿

---

#### 6. 错误监控缺失

**问题描述**：
- 没有 Sentry 等错误监控
- 用户遇到错误后，开发者无法主动感知
- 难以收集错误上下文

**建议**：二期接入 Sentry 或 LogRocket

---

### 🟢 低风险

#### 7. 用户引导不足

**问题描述**：
- 新用户上手缺少引导
- 错误提示不够友好
- 复杂操作缺少教程

**当前状态**：可以后续迭代优化

---

## 阶段性评估

### 一期目标评估

> **目标**: 10 人并发，内部团队 + A 级商单，1 小时抽完 2 分钟 AI 漫剧

| 能力 | 评估 | 行动项 |
|------|------|--------|
| **架构稳定性** | ✅ 满足 | 升级 Vercel Pro |
| **功能完备性** | ✅ 满足 | 当前功能足够 |
| **10 人并发** | ⚠️ 需验证 | 组织并发测试 |
| **用户体验** | ⚠️ 需优化 | 添加错误提示和引导 |

**结论**: 一期目标**基本可达成**，但需完成验证清单

---

### 二期目标评估

> **目标**: 100+ 私教学员或工作室成员

| 需要新增 | 优先级 | 预估工作量 |
|----------|--------|------------|
| 任务队列系统 | 🔴 必须 | 2-3 周 |
| API 限流处理 | 🔴 必须 | 1 周 |
| 用户配额管理 | 🔴 必须 | 1 周 |
| Sentry 错误监控 | 🟡 建议 | 2 天 |
| 用户引导教程 | 🟡 建议 | 1 周 |
| 性能监控 | 🟡 建议 | 2 天 |

**结论**: 二期目标**需要架构升级**

---

### C 端产品评估

> **目标**: 主流 C 端产品

| 需要 | 说明 |
|------|------|
| 自有后端服务 | 不能完全依赖 Serverless |
| 分布式任务队列 | Redis + Bull 或云服务 |
| 微服务拆分 | AI 服务、用户服务分开 |
| CDN 优化 | 视频分发加速 |
| 付费系统 | Stripe/支付宝集成 |
| 合规性 | 用户协议、内容审核 |

**结论**: 需要**持续架构演进**，但当前基础**留有扩展空间**

---

## 验证清单

### 一期验证（必须完成）

| 序号 | 验证项 | 方法 | 结果 | 日期 |
|------|--------|------|------|------|
| 1 | Vercel Pro 超时是否足够 | 测试 60s 内请求是否稳定 | ⬜ | |
| 2 | 5 人并发批量图片生成 | 同时触发 batchGenerateProjectImages | ⬜ | |
| 3 | 5 人并发 Sora 视频生成 | 同时触发 batchGenerateProjectVideosSora | ⬜ | |
| 4 | Gemini API 限流情况 | 批量生成时观察 429 错误 | ⬜ | |
| 5 | Kaponai API 并发能力 | 联系服务商确认 / 实测 | ⬜ | |
| 6 | 100 镜头项目加载性能 | 测量加载时间，观察卡顿 | ⬜ | |
| 7 | 浏览器关闭后任务恢复 | 提交 Sora 任务后关闭浏览器 | ⬜ | |

### 二期验证（扩展前完成）

| 序号 | 验证项 | 方法 | 结果 | 日期 |
|------|--------|------|------|------|
| 8 | 10 人并发批量生成 | 压力测试 | ⬜ | |
| 9 | 多人编辑同一项目 | 观察数据覆盖 | ⬜ | |
| 10 | 长时间使用内存泄漏 | 浏览器 Performance 监控 | ⬜ | |
| 11 | Supabase 连接数限制 | 监控活跃连接 | ⬜ | |

---

## 优化路径建议

### 近期（一期验证阶段）

```
现在
├─ [1周] 升级 Vercel 到 Pro 版
├─ [2天] 添加 API 限流错误的友好提示
├─ [3天] 组织 5 人并发测试
└─ [持续] 收集用户反馈
```

### 中期（二期扩展阶段）

```
一期稳定后
├─ [2-3周] 引入任务队列
│   ├─ 方案A: Cloudflare Queues (与 Vercel 配合需调研)
│   ├─ 方案B: Upstash Redis + Bull (Serverless 兼容)
│   └─ 方案C: AWS SQS + Lambda
├─ [1周] 添加 API 调用限流和排队
├─ [1周] 用户配额管理优化
├─ [2天] 接入 Sentry 错误监控
└─ [1周] 用户引导教程
```

### 远期（C 端产品阶段）

```
100 人稳定后
├─ 评估是否需要自建后端
├─ 微服务拆分规划
├─ 付费系统集成
└─ 合规性建设
```

---

## 验证记录

> 在下方记录每次验证的结果

### 验证 #1: [验证项名称]

**日期**: YYYY-MM-DD  
**测试人**: [姓名]  
**测试环境**: [生产/测试]

**测试步骤**:
1. ...
2. ...

**测试结果**:
- [ ] 通过 / [ ] 失败

**问题记录**:
- ...

**解决方案**:
- ...

---

### 验证 #2: [验证项名称]

**日期**: YYYY-MM-DD  
...

---

## 总结

| 阶段 | 结论 |
|------|------|
| **一期 (10人)** | ✅ 架构可支撑，需完成验证 |
| **二期 (100人)** | ⚠️ 需要架构升级（任务队列） |
| **C端产品** | 🔄 持续演进，当前基础良好 |

**核心信心点**：
1. 统一数据层 (`dataService`) 设计良好，迁移成本低
2. 服务分离清晰，单个服务可独立升级
3. 云原生托管服务（Supabase + R2）可水平扩展
4. TypeScript 类型安全，重构风险可控

**核心关注点**：
1. 第三方 API 并发限制是最大不确定性
2. 任务队列是二期必须的架构升级
3. 需要建立监控体系以主动发现问题

---

**文档维护者**: 西羊石团队  
**最后更新**: 2026-01-19
