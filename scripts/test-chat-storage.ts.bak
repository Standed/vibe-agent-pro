/**
 * æµ‹è¯•èŠå¤©å­˜å‚¨åŠŸèƒ½
 * è¿è¡Œæ–¹å¼ï¼šåœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ‰§è¡Œ
 */

import { dataService } from '@/lib/dataService';
import { ChatMessage } from '@/types/project';
import { v4 as uuidv4 } from 'uuid';

/**
 * æµ‹è¯•èŠå¤©å­˜å‚¨ API
 */
export async function testChatStorage(projectId: string, userId: string) {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•èŠå¤©å­˜å‚¨...');

  try {
    // 1. ä¿å­˜é¡¹ç›®çº§å¯¹è¯
    console.log('\n1ï¸âƒ£ æµ‹è¯•ä¿å­˜é¡¹ç›®çº§å¯¹è¯...');
    const projectMsg: ChatMessage = {
      id: uuidv4(),
      userId,
      projectId,
      scope: 'project',
      role: 'user',
      content: 'æµ‹è¯•é¡¹ç›®çº§å¯¹è¯æ¶ˆæ¯',
      timestamp: new Date(),
      createdAt: new Date(),
      updatedAt: new Date(),
    };
    await dataService.saveChatMessage(projectMsg);
    console.log('âœ… é¡¹ç›®çº§å¯¹è¯ä¿å­˜æˆåŠŸ:', projectMsg.id);

    // 2. ä¿å­˜ AI å›å¤ï¼ˆå¸¦ thoughtï¼‰
    console.log('\n2ï¸âƒ£ æµ‹è¯•ä¿å­˜ AI å›å¤...');
    const aiMsg: ChatMessage = {
      id: uuidv4(),
      userId,
      projectId,
      scope: 'project',
      role: 'assistant',
      content: 'è¿™æ˜¯ AI çš„å›å¤',
      thought: 'æˆ‘æ­£åœ¨æ€è€ƒå¦‚ä½•å›ç­”...',
      metadata: {
        model: 'doubao-pro',
      },
      timestamp: new Date(),
      createdAt: new Date(),
      updatedAt: new Date(),
    };
    await dataService.saveChatMessage(aiMsg);
    console.log('âœ… AI å›å¤ä¿å­˜æˆåŠŸ:', aiMsg.id);

    // 3. è·å–é¡¹ç›®çº§å¯¹è¯
    console.log('\n3ï¸âƒ£ æµ‹è¯•è·å–é¡¹ç›®çº§å¯¹è¯...');
    const projectMessages = await dataService.getChatMessages({
      projectId,
      scope: 'project',
    });
    console.log(`âœ… è·å–åˆ° ${projectMessages.length} æ¡é¡¹ç›®çº§å¯¹è¯`);
    console.table(projectMessages.map(m => ({
      id: m.id.substring(0, 8),
      role: m.role,
      content: m.content.substring(0, 30),
      scope: m.scope,
    })));

    // 4. ä¿å­˜åœºæ™¯çº§å¯¹è¯ï¼ˆå¦‚æœæœ‰åœºæ™¯ï¼‰
    console.log('\n4ï¸âƒ£ æµ‹è¯•ä¿å­˜åœºæ™¯çº§å¯¹è¯...');
    const sceneMsg: ChatMessage = {
      id: uuidv4(),
      userId,
      projectId,
      sceneId: 'test-scene-id', // æ›¿æ¢ä¸ºçœŸå®çš„åœºæ™¯ID
      scope: 'scene',
      role: 'user',
      content: 'æµ‹è¯•åœºæ™¯çº§å¯¹è¯æ¶ˆæ¯',
      timestamp: new Date(),
      createdAt: new Date(),
      updatedAt: new Date(),
    };
    await dataService.saveChatMessage(sceneMsg);
    console.log('âœ… åœºæ™¯çº§å¯¹è¯ä¿å­˜æˆåŠŸ:', sceneMsg.id);

    // 5. è·å–åœºæ™¯çº§å¯¹è¯
    console.log('\n5ï¸âƒ£ æµ‹è¯•è·å–åœºæ™¯çº§å¯¹è¯...');
    const sceneMessages = await dataService.getChatMessages({
      projectId,
      sceneId: 'test-scene-id',
      scope: 'scene',
    });
    console.log(`âœ… è·å–åˆ° ${sceneMessages.length} æ¡åœºæ™¯çº§å¯¹è¯`);

    // 6. æµ‹è¯•åˆ é™¤æ¶ˆæ¯
    console.log('\n6ï¸âƒ£ æµ‹è¯•åˆ é™¤å•æ¡æ¶ˆæ¯...');
    await dataService.deleteChatMessage(projectMsg.id);
    console.log('âœ… æ¶ˆæ¯åˆ é™¤æˆåŠŸ:', projectMsg.id);

    // 7. æµ‹è¯•æ¸…é™¤åœºæ™¯å¯¹è¯
    console.log('\n7ï¸âƒ£ æµ‹è¯•æ¸…é™¤åœºæ™¯å¯¹è¯å†å²...');
    await dataService.clearChatHistory({
      projectId,
      sceneId: 'test-scene-id',
    });
    console.log('âœ… åœºæ™¯å¯¹è¯å†å²æ¸…é™¤æˆåŠŸ');

    // 8. éªŒè¯æ¸…é™¤ç»“æœ
    console.log('\n8ï¸âƒ£ éªŒè¯æ¸…é™¤ç»“æœ...');
    const afterClear = await dataService.getChatMessages({
      projectId,
      sceneId: 'test-scene-id',
    });
    console.log(`âœ… åœºæ™¯å¯¹è¯æ•°é‡: ${afterClear.length}ï¼ˆåº”è¯¥ä¸º 0ï¼‰`);

    console.log('\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
    return true;
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
    return false;
  }
}

/**
 * å¿«é€Ÿæµ‹è¯•ï¼ˆåœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼‰
 */
export async function quickTest() {
  // è·å–å½“å‰é¡¹ç›®å’Œç”¨æˆ·
  const project = (window as any).project; // ä»å…¨å±€å˜é‡è·å–
  const user = (window as any).user;

  if (!project || !user) {
    console.error('âŒ è¯·å…ˆæ‰“å¼€ä¸€ä¸ªé¡¹ç›®');
    return;
  }

  console.log('ğŸ“‹ é¡¹ç›®ID:', project.id);
  console.log('ğŸ‘¤ ç”¨æˆ·ID:', user.id);

  await testChatStorage(project.id, user.id);
}

// å¯¼å‡ºä¾›æ§åˆ¶å°ä½¿ç”¨
if (typeof window !== 'undefined') {
  (window as any).testChatStorage = testChatStorage;
  (window as any).quickTest = quickTest;
}
