# ğŸ”§ Internal Server Error ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-01-02
**é—®é¢˜**: Internal Server Errorï¼ˆå†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼‰
**æ ¹æœ¬åŸå› **: å®¢æˆ·ç«¯å°è¯•ä¸‹è½½ç«å±±å¼•æ“å›¾ç‰‡ URL å¯¼è‡´ CORS é”™è¯¯

---

## ğŸ› é—®é¢˜åˆ†æ

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Š "Internal Server Error"ï¼Œåœ¨æµ‹è¯•æ—¶å‘ç°ï¼š

1. **å®¢æˆ·ç«¯ CORS é”™è¯¯**: `VolcanoEngineService` åœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä½¿ç”¨ `fetch()` ä¸‹è½½ç«å±±å¼•æ“è¿”å›çš„å›¾ç‰‡ URL
2. **è·¨åŸŸé™åˆ¶**: ç«å±±å¼•æ“çš„å›¾ç‰‡ URL ä¸å…è®¸è·¨åŸŸè®¿é—®ï¼Œå¯¼è‡´ `fetch()` å¤±è´¥
3. **é”™è¯¯ä¼ æ’­**: å®¢æˆ·ç«¯ä¸‹è½½å¤±è´¥å¯¼è‡´æ•´ä¸ªå›¾ç‰‡ç”Ÿæˆæµç¨‹ä¸­æ–­

### å—å½±å“çš„åŠŸèƒ½
- âœ… å•å›¾ç”Ÿæˆï¼ˆSeeDream 4.5ï¼‰
- âœ… å›¾ç‰‡ç¼–è¾‘ï¼ˆSeeDream 4.5 Image-to-Imageï¼‰
- âœ… è§’è‰²ä¸‰è§†å›¾ç”Ÿæˆ
- âœ… æ‰¹é‡ç”Ÿæˆï¼ˆSeeDream æ¨¡å¼ï¼‰

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
**å°†å›¾ç‰‡ä¸‹è½½å’Œ base64 è½¬æ¢ä»å®¢æˆ·ç«¯ç§»è‡³æœåŠ¡å™¨ç«¯**ï¼Œé¿å… CORS é™åˆ¶ã€‚

### æ¶æ„å˜æ›´

**ä¹‹å‰çš„æµç¨‹**ï¼ˆæœ‰é—®é¢˜ï¼‰:
```
å®¢æˆ·ç«¯ â†’ Volcano API â†’ è¿”å›å›¾ç‰‡ URL â†’ å®¢æˆ·ç«¯ä¸‹è½½ â†’ âŒ CORS é”™è¯¯
```

**ä¿®å¤åçš„æµç¨‹**ï¼ˆæ­£ç¡®ï¼‰:
```
å®¢æˆ·ç«¯ â†’ Next.js API è·¯ç”± â†’ Volcano API â†’ è¿”å›å›¾ç‰‡ URL â†’
æœåŠ¡å™¨ç«¯ä¸‹è½½ â†’ Base64 è½¬æ¢ â†’ è¿”å› data URL â†’ å®¢æˆ·ç«¯ä¿å­˜ âœ…
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `/src/app/api/seedream/route.ts` (ä¿®æ”¹)
**å˜æ›´å†…å®¹**: æ–°å¢æœåŠ¡å™¨ç«¯å›¾ç‰‡ä¸‹è½½å’Œ base64 è½¬æ¢é€»è¾‘

**å…³é”®ä»£ç **:
```typescript
// ğŸ”¥ ä¸‹è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64 data URLï¼Œé¿å…å®¢æˆ·ç«¯ CORS å’Œ URL è¿‡æœŸé—®é¢˜
try {
  const imageResp = await fetch(url);
  if (!imageResp.ok) {
    console.warn('Failed to download image, returning original URL:', imageResp.statusText);
    return NextResponse.json({ url });
  }

  const blob = await imageResp.blob();
  const mimeType = blob.type || 'image/png';
  const arrayBuffer = await blob.arrayBuffer();
  const base64 = Buffer.from(arrayBuffer).toString('base64');
  const dataUrl = `data:${mimeType};base64,${base64}`;

  console.log('âœ… SeeDream å›¾ç‰‡å·²è½¬æ¢ä¸º base64 data URL');
  return NextResponse.json({ url: dataUrl });
} catch (downloadError: any) {
  console.warn('Failed to convert image to base64, returning original URL:', downloadError);
  return NextResponse.json({ url });
}
```

**ä¼˜é›…é™çº§**: å¦‚æœæœåŠ¡å™¨ç«¯ä¸‹è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹ URL å¹¶å‘å‡ºè­¦å‘Šï¼Œä¸ä¼šå¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­ã€‚

---

### 2. `/src/app/api/seedream-edit/route.ts` (æ–°å»º)
**å˜æ›´å†…å®¹**: æ–°å»ºå›¾ç‰‡ç¼–è¾‘ API è·¯ç”±ï¼Œå¤„ç† SeeDream Image-to-Image ç¼–è¾‘

**åŠŸèƒ½**:
- æ¥æ”¶åŸå›¾ URL å’Œç¼–è¾‘æç¤ºè¯
- è°ƒç”¨ç«å±±å¼•æ“ `/images/variations` API
- æœåŠ¡å™¨ç«¯ä¸‹è½½è¿”å›çš„å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64
- è¿”å› data URL ç»™å®¢æˆ·ç«¯

**API æ¥å£**:
```
POST /api/seedream-edit
Body: {
  imageUrl: string,    // åŸå›¾ URLï¼ˆæ”¯æŒ data URLï¼‰
  prompt: string,      // ç¼–è¾‘æç¤ºè¯
  size: string,        // å›¾ç‰‡å°ºå¯¸ï¼ˆä¾‹å¦‚ "2560x1440"ï¼‰
  model: string        // æ¨¡å‹ IDï¼ˆå¯é€‰ï¼‰
}
Response: {
  url: string          // Base64 data URL
}
```

---

### 3. `/src/services/volcanoEngineService.ts` (é‡æ„)
**å˜æ›´å†…å®¹**: ä¿®æ”¹ `generateSingleImage()` å’Œ `editImage()` æ–¹æ³•ï¼Œè°ƒç”¨ API è·¯ç”±è€Œéç›´æ¥è°ƒç”¨ç«å±±å¼•æ“

**ä¹‹å‰çš„å®ç°**ï¼ˆæœ‰é—®é¢˜ï¼‰:
```typescript
// âŒ å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ç«å±±å¼•æ“ API
const response = await fetch(`${this.baseUrl}/images/generations`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: `Bearer ${this.apiKey}`,
  },
  body: JSON.stringify({ ... }),
});

// âŒ å®¢æˆ·ç«¯å°è¯•ä¸‹è½½å›¾ç‰‡ï¼ˆCORS é”™è¯¯ï¼‰
const dataUrl = await this.downloadImageAsDataUrl(imageUrl);
```

**ä¿®å¤åçš„å®ç°**ï¼ˆæ­£ç¡®ï¼‰:
```typescript
// âœ… å®¢æˆ·ç«¯è°ƒç”¨ Next.js API è·¯ç”±
const response = await fetch('/api/seedream', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    prompt,
    size,
    model: this.seedreamModelId,
  }),
});

// âœ… API è·¯ç”±å·²ç»è¿”å› base64 data URLï¼Œæ— éœ€å®¢æˆ·ç«¯ä¸‹è½½
return data.url;
```

**ç§»é™¤çš„æ–¹æ³•**:
- `private async downloadImageAsDataUrl(imageUrl: string)` - ä¸å†éœ€è¦ï¼Œå·²ç§»è‡³æœåŠ¡å™¨ç«¯

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. ç¼–è¯‘æµ‹è¯•
```bash
npm run build
```
**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### 2. å¼€å‘æœåŠ¡å™¨æµ‹è¯•
```bash
npm run dev
```
**ç»“æœ**: âœ… å¯åŠ¨æˆåŠŸï¼Œç«¯å£ 3001

### 3. åŠŸèƒ½æµ‹è¯•å»ºè®®
è¯·æµ‹è¯•ä»¥ä¸‹åœºæ™¯ä»¥éªŒè¯ä¿®å¤:

1. **å•å›¾ç”Ÿæˆ**:
   - é€‰æ‹©ä¸€ä¸ªé•œå¤´
   - é€‰æ‹©"å•å›¾ç”Ÿæˆ"
   - è¾“å…¥æç¤ºè¯
   - ç‚¹å‡»"ç”Ÿæˆå•å›¾"
   - âœ… ç¡®è®¤å›¾ç‰‡ç”Ÿæˆåç«‹å³æ˜¾ç¤ºä¸”åˆ·æ–°é¡µé¢ä»ç„¶å¯è§

2. **å›¾ç‰‡ç¼–è¾‘**:
   - é€‰æ‹©ä¸€ä¸ªå·²æœ‰å›¾ç‰‡çš„é•œå¤´
   - é€‰æ‹©"å›¾ç‰‡ç¼–è¾‘"
   - è¾“å…¥ç¼–è¾‘æç¤ºè¯
   - ç‚¹å‡»"ç¼–è¾‘å›¾ç‰‡"
   - âœ… ç¡®è®¤ç¼–è¾‘åçš„å›¾ç‰‡æ˜¾ç¤ºä¸”åˆ·æ–°é¡µé¢ä»ç„¶å¯è§

3. **è§’è‰²ä¸‰è§†å›¾**:
   - æ·»åŠ æ–°è§’è‰²
   - å¡«å†™è§’è‰²ä¿¡æ¯
   - ç‚¹å‡»"AI ç”Ÿæˆä¸‰è§†å›¾"
   - âœ… ç¡®è®¤ä¸‰è§†å›¾ç”Ÿæˆå¹¶ä¿å­˜åˆ°è§’è‰²å‚è€ƒå›¾

4. **æ‰¹é‡ç”Ÿæˆ**:
   - é€‰æ‹©åœºæ™¯
   - ç‚¹å‡»"æ‰¹é‡ç”Ÿæˆ"
   - é€‰æ‹© SeeDream æ¨¡å¼
   - ç‚¹å‡»"å¼€å§‹æ‰¹é‡ç”Ÿæˆ"
   - âœ… ç¡®è®¤æ‰€æœ‰é•œå¤´å›¾ç‰‡ç”Ÿæˆä¸”æ°¸ä¹…ä¿å­˜

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### Before (ä¿®å¤å‰)
- âŒ å®¢æˆ·ç«¯ CORS é”™è¯¯
- âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥
- âŒ Internal Server Error
- âŒ å›¾ç‰‡æ— æ³•ä¿å­˜

### After (ä¿®å¤å)
- âœ… æœåŠ¡å™¨ç«¯ä¸‹è½½ï¼Œæ—  CORS é—®é¢˜
- âœ… è‡ªåŠ¨è½¬æ¢ä¸º base64 data URL
- âœ… å›¾ç‰‡æ°¸ä¹…ä¿å­˜åœ¨ IndexedDB
- âœ… åˆ·æ–°é¡µé¢å›¾ç‰‡ä»ç„¶å¯è§
- âœ… ä¼˜é›…é™çº§ï¼Œä¸ä¼šä¸­æ–­æµç¨‹

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. Server-Side Processingï¼ˆæœåŠ¡å™¨ç«¯å¤„ç†ï¼‰
- åˆ©ç”¨ Next.js API Routes åœ¨æœåŠ¡å™¨ç«¯ä¸‹è½½å›¾ç‰‡
- é¿å…å®¢æˆ·ç«¯ CORS é™åˆ¶
- ä½¿ç”¨ Node.js `Buffer` è¿›è¡Œé«˜æ•ˆ base64 è½¬æ¢

### 2. Graceful Degradationï¼ˆä¼˜é›…é™çº§ï¼‰
- å¦‚æœæœåŠ¡å™¨ç«¯ä¸‹è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹ URL
- ä¸ä¼šå¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­
- æ§åˆ¶å°è¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•

### 3. Clean Architectureï¼ˆæ¸…æ™°æ¶æ„ï¼‰
- API è·¯ç”±ä¸“æ³¨äºæ•°æ®å¤„ç†
- å®¢æˆ·ç«¯æœåŠ¡åªè´Ÿè´£ä¸šåŠ¡é€»è¾‘
- èŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [TESTING.md](./TESTING.md) - åŠŸèƒ½æµ‹è¯•æŒ‡å—ï¼ˆå·²æ›´æ–°ï¼‰
- [SECURITY.md](./SECURITY.md) - React å®‰å…¨æ¼æ´æ£€æŸ¥æŠ¥å‘Š

---

## ğŸ”œ åç»­ä¼˜åŒ–å»ºè®®

### 1. å›¾ç‰‡å‹ç¼©
Base64 å›¾ç‰‡è¾ƒå¤§ï¼Œè€ƒè™‘ï¼š
- ä½¿ç”¨å›¾ç‰‡å‹ç¼©ç®—æ³•ï¼ˆå¦‚ Sharpã€ImageMagickï¼‰
- æ”¯æŒ WebP æ ¼å¼ï¼ˆæ›´å°ä½“ç§¯ï¼‰
- å¯é…ç½®å‹ç¼©è´¨é‡

### 2. äº‘å­˜å‚¨é›†æˆ
æœªæ¥å¯ä»¥è€ƒè™‘ï¼š
- ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS / AWS S3
- è·å–æ°¸ä¹… CDN URL
- å‡å°‘ IndexedDB å­˜å‚¨å‹åŠ›

### 3. ç¼“å­˜ä¼˜åŒ–
- å®ç° API å“åº”ç¼“å­˜
- é¿å…é‡å¤ä¸‹è½½ç›¸åŒå›¾ç‰‡
- ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜

---

**ä¿®å¤å®Œæˆ** âœ…
**çŠ¶æ€**: å¯ä»¥ç»§ç»­å¼€å‘å’Œéƒ¨ç½²
**ä¸‹æ¬¡æµ‹è¯•å»ºè®®**: 2025-01-15
