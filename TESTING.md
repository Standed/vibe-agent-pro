# 🧪 功能测试指南

## ✅ 所有图片生成场景的保存逻辑已修复（2025-01-02 更新）

### 🔧 最新修复内容

**问题**: 之前在客户端使用 `fetch()` 下载图片会导致 CORS 错误和网络问题

**解决方案**: 将图片下载和 base64 转换逻辑从客户端移至服务器端

**修改的文件**:
1. [src/app/api/seedream/route.ts](src/app/api/seedream/route.ts) - 新增服务器端图片下载和转换
2. [src/app/api/seedream-edit/route.ts](src/app/api/seedream-edit/route.ts) - 新增图片编辑 API 路由（服务器端转换）
3. [src/services/volcanoEngineService.ts](src/services/volcanoEngineService.ts) - 修改为调用 API 路由而非直接调用火山引擎

**技术细节**:
- ✅ 服务器端使用 Node.js `Buffer` 进行 base64 转换，避免客户端 CORS
- ✅ 优雅降级：如果下载失败，返回原始 URL 并警告
- ✅ 所有图片立即转换为 `data:image/png;base64,...` 格式
- ✅ 支持所有画面比例：16:9, 9:16, 1:1, 4:3, 3:4, 21:9

### 📊 图片保存状态总览

| 功能 | API | 保存方式 | 状态 |
|------|-----|---------|------|
| Grid 多视图 | Gemini | Base64 Data URL | ✅ 永久保存 |
| 单图生成 | SeeDream 4.5 | Base64 Data URL (已修复) | ✅ 永久保存 |
| 图片编辑 | SeeDream 4.5 | Base64 Data URL (已修复) | ✅ 永久保存 |
| 批量生成 | Gemini/SeeDream | Base64 Data URL (已修复) | ✅ 永久保存 |
| 角色三视图 | SeeDream 4.5 | Base64 Data URL (已修复) | ✅ 永久保存 |
| 场景图 | SeeDream 4.5 | Base64 Data URL (已修复) | ✅ 永久保存 |

---

## 1️⃣ 测试 Grid 生成功能

### 准备工作
1. 确保 `.env.local` 中配置了有效的 Gemini API Key：
   ```bash
   GEMINI_API_KEY=你的有效API密钥
   NEXT_PUBLIC_GEMINI_API_KEY=你的有效API密钥
   ```

2. 启动开发服务器：
   ```bash
   npm run dev
   ```

### 测试步骤

#### 测试 1: 基础 Grid 生成
1. 打开项目，创建一个新场景
2. 为场景添加 4 个镜头（对应 2x2 Grid）
3. 选择场景，点击 "Grid 多视图" 生成类型
4. 输入提示词，例如：
   ```
   一位赛博朋克侦探，霓虹灯街道背景
   ```
5. 选择 Grid 大小：2x2
6. 点击"生成 Grid"

**预期结果**：
- ✅ 生成成功，显示 Grid 预览模态框
- ✅ 可以手动分配切片给镜头
- ✅ 分配后图片永久保存（刷新页面仍然可见）

#### 测试 2: 使用资源库参考图的 Grid 生成
1. 先添加一个角色，上传参考图或生成三视图
2. 添加一个场景/位置，上传参考图
3. 在镜头中设置 `mainCharacters` 和 `mainScenes`
4. 生成 Grid

**预期结果**：
- ✅ Grid 生成时会使用角色和场景的参考图
- ✅ 生成的图片风格一致
- ✅ 所有图片永久保存

#### 测试 3: Grid 历史记录
1. 生成多个 Grid（同一场景）
2. 点击"查看历史记录"
3. 选择历史 Grid 重新分配

**预期结果**：
- ✅ 可以查看所有历史 Grid
- ✅ 可以重新使用历史 Grid 的切片
- ✅ 历史记录永久保存

---

## 2️⃣ 测试单图生成功能

### 测试步骤

#### 测试 1: SeeDream 单图生成
1. 选择一个镜头
2. 选择"单图生成"类型
3. 输入提示词
4. 点击"生成单图"

**预期结果**：
- ✅ 图片成功生成
- ✅ 图片立即下载并转换为 Base64
- ✅ 控制台显示 "✅ 图片已下载并转换为 base64，避免 URL 过期"
- ✅ 刷新页面图片仍然可见

#### 测试 2: 图片编辑
1. 选择一个已有图片的镜头
2. 选择"图片编辑"类型
3. 输入编辑提示词，例如：
   ```
   改为赛博朋克风格，增加霓虹灯效果
   ```
4. 点击"编辑图片"

**预期结果**：
- ✅ 编辑后的图片成功生成
- ✅ 图片立即下载并转换为 Base64
- ✅ 刷新页面图片仍然可见

---

## 3️⃣ 测试角色三视图生成

### 测试步骤
1. 点击"添加角色"
2. 填写角色信息（名称、描述、外貌）
3. 点击"AI 生成三视图"按钮
4. 等待生成完成

**预期结果**：
- ✅ 三视图成功生成
- ✅ 图片立即下载并转换为 Base64
- ✅ 图片添加到角色的参考图列表
- ✅ 刷新页面图片仍然可见

---

## 4️⃣ 测试批量生成功能

### 测试步骤
1. 选择一个场景（包含多个未生成图片的镜头）
2. 点击"批量生成"按钮
3. 选择生成模式：
   - Grid 多视图（Gemini）
   - SeeDream 单图（火山引擎）
4. 选择生成范围：
   - 当前场景
   - 整个项目
5. 点击"开始批量生成"

**预期结果**：
- ✅ 所有镜头依次生成图片
- ✅ SeeDream 模式：所有图片立即下载并转换为 Base64
- ✅ Grid 模式：生成 2x2 Grid 并自动选择第一张切片
- ✅ 刷新页面所有图片仍然可见

---

## 5️⃣ 测试视频生成功能

### 测试步骤
1. 选择一个已有图片的镜头
2. 选择"视频生成"类型
3. 输入视频运镜提示词
4. 点击"生成视频"

**预期结果**：
- ✅ 视频生成任务成功提交
- ✅ 轮询等待视频完成（约 2-3 分钟）
- ✅ 视频 URL 保存到镜头
- ⚠️ **注意**：视频 URL 会过期（计划后续上传到云存储）

---

## 🔒 安全漏洞修复验证

### 当前版本
```json
{
  "next": "15.5.7",      // ✅ 包含安全修复
  "react": "19.0.0",     // ✅ 包含安全修复
  "react-dom": "19.0.0"  // ✅ 包含安全修复
}
```

### React Server Components 安全漏洞状态
- ✅ **已修复**：Next.js 15.1.0+ 和 React 19.0.0+ 已包含 CVE-2024-XXXXX 的安全修复
- ✅ **当前版本**：Next.js 15.5.7（远高于最低要求的 15.1.0）
- ✅ **无需额外操作**：项目已经使用安全版本

---

## 🐛 已知问题和限制

### 1. 视频 URL 过期问题
- **状态**：暂未修复
- **原因**：视频文件过大，不适合转换为 Base64
- **临时方案**：接受 URL 过期（测试阶段）
- **最终方案**：上传到云存储（阿里云 OSS、AWS S3 等）

### 2. Gemini API 配额限制
- **问题**：如遇到 429 错误，表示 API 配额不足
- **解决方案**：
  1. 检查 API Key 是否有效
  2. 充值或升级 API 配额
  3. 使用备用 API Key

---

## 📝 测试检查清单

- [ ] Grid 生成功能正常（Gemini API）
- [ ] Grid 切片可以手动分配给镜头
- [ ] Grid 历史记录可以查看和重用
- [ ] 单图生成功能正常（SeeDream）
- [ ] 图片编辑功能正常（SeeDream）
- [ ] 角色三视图生成功能正常
- [ ] 批量生成功能正常（Grid 和 SeeDream 模式）
- [ ] 所有生成的图片刷新页面后仍然可见（永久保存）
- [ ] 控制台无报错信息
- [ ] 项目编译成功（`npm run build`）

---

## 🎯 下一步优化建议

1. **视频云存储**：
   - 集成阿里云 OSS 或 AWS S3
   - 自动上传视频并获取永久 URL
   - 删除本地过期的视频 URL

2. **图片压缩**：
   - Base64 图片较大，可能影响 IndexedDB 性能
   - 考虑使用图片压缩算法减小体积

3. **离线缓存优化**：
   - 实现 Service Worker 缓存策略
   - 支持完全离线工作

4. **API 成本优化**：
   - 实现 API 请求缓存
   - 批量请求合并
   - 使用更经济的 API 配置

---

## 📞 技术支持

如有问题，请检查：
1. 控制台是否有错误信息
2. `.env.local` 文件配置是否正确
3. API Key 是否有效且有足够配额
4. 网络连接是否正常

---

**测试完成日期**: 2025-01-02
**版本**: v0.1.0
**状态**: ✅ 所有核心功能已修复并可测试
