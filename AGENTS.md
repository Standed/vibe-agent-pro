# Video Agent Pro - AGENTS æŒ‡å—

AI é©±åŠ¨çš„è§†é¢‘åˆ†é•œç”Ÿæˆä¸ç¼–è¾‘å·¥å…· | Next.js 15.1 + React 19 + TypeScript 5.8

---

## ğŸš€ å¼€å‘ç¯å¢ƒæç¤º

### å¯åŠ¨ä¸æ„å»º
- **å¼€å‘æ¨¡å¼**: `npm run dev` (å¯åŠ¨ Turbopackï¼Œæ”¯æŒçƒ­é‡è½½ï¼Œç«¯å£ 3000)
- **âš ï¸ ä¸è¦åœ¨å¼€å‘æ—¶è¿è¡Œ `npm run build`** - è¿™ä¼šåˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ï¼Œç ´åçƒ­é‡è½½
- **ç”Ÿäº§æ„å»º**: `npm run build` (ä»…åœ¨éœ€è¦éƒ¨ç½²æˆ–ç±»å‹æ£€æŸ¥æ—¶è¿è¡Œ)
- **ä»£ç æ£€æŸ¥**: `npm run lint` (ESLint è§„åˆ™æ£€æŸ¥)

---

## ğŸ› æ ¸å¿ƒæ¶æ„

### æœåŠ¡å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Frontend (React)                            â”‚
â”‚  useAgent Hook â†’ AgentService â†’ Tool Calls â†’ AgentToolExecutor       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GeminiService  â”‚  â”‚ VolcanoService   â”‚  â”‚  SoraOrchestratorâ”‚
â”‚   (å›¾ç‰‡ç”Ÿæˆ/åˆ†æ) â”‚  â”‚  (SeeDreamè§†é¢‘)  â”‚  â”‚   (Soraè§†é¢‘ç¼–æ’) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â–¼                      â–¼                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ KaponaiService  â”‚  â”‚CharacterConsistencyâ”‚ â”‚SoraPromptServiceâ”‚
                    â”‚  (Sora API)     â”‚  â”‚    Service         â”‚ â”‚  (Promptç”Ÿæˆ)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæœåŠ¡æ–‡ä»¶æ¸…å•

| æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| **Agent æ ¸å¿ƒ** | `src/services/agentService.ts` | AI Agent æ¨ç†ã€Function Calling |
| **Agent å·¥å…·æ‰§è¡Œ** | `src/services/agentTools.ts` | å·¥å…·å®é™…æ‰§è¡Œé€»è¾‘ |
| **å·¥å…·å®šä¹‰** | `src/services/agentToolDefinitions.ts` | å·¥å…· JSON Schema (å®¢æˆ·ç«¯å®‰å…¨) |
| **Gemini æœåŠ¡** | `src/services/geminiService.ts` | å›¾ç‰‡ç”Ÿæˆã€Grid åˆ‡ç‰‡ã€åˆ†æ |
| **ç«å±±å¼•æ“æœåŠ¡** | `src/services/volcanoEngineService.ts` | SeeDream å›¾ç‰‡ã€SeeDance è§†é¢‘ |
| **Sora ç¼–æ’å™¨** | `src/services/SoraOrchestrator.ts` | Sora è§†é¢‘ç”Ÿæˆå…¨æµç¨‹ç¼–æ’ |
| **Kaponai æœåŠ¡** | `src/services/KaponaiService.ts` | Sora API åº•å±‚å°è£… |
| **è§’è‰²ä¸€è‡´æ€§** | `src/services/CharacterConsistencyService.ts` | è§’è‰²æ³¨å†Œä¸å‚è€ƒè§†é¢‘ç”Ÿæˆ |
| **Sora Prompt** | `src/services/SoraPromptService.ts` | Sora ä¸“ç”¨æç¤ºè¯ç”Ÿæˆ |
| **åˆ†é•œæ¿æœåŠ¡** | `src/services/StoryboardService.ts` | å‰§æœ¬è§£æä¸åˆ†é•œç”Ÿæˆ |
| **å³æ¢¦æœåŠ¡** | `src/services/jimengService.ts` | å³æ¢¦ API é›†æˆ |

---

## ğŸ¤– Agent å·¥å…·åˆ—è¡¨

Agent é€šè¿‡ Function Calling è°ƒç”¨ä»¥ä¸‹å·¥å…·æ“ä½œé¡¹ç›®ï¼š

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `getProjectContext` | è·å–é¡¹ç›®æ¦‚è§ˆ | - |
| `getSceneDetails` | è·å–åœºæ™¯è¯¦æƒ… | `sceneId` |
| `getShotDetails` | è·å–åˆ†é•œè¯¦æƒ… | `shotId` |
| `searchScenes` | æœç´¢åœºæ™¯ | `query` |
| `createScene` | åˆ›å»ºæ–°åœºæ™¯ | `name`, `description` |
| `addShots` | æ·»åŠ åˆ†é•œ | `sceneId`, `count`, `description`, `shots[]` |
| `generateShotImage` | ç”Ÿæˆåˆ†é•œå›¾ç‰‡ | `shotId`, `mode`, `gridSize`, `prompt`, `force` |
| `batchGenerateSceneImages` | æ‰¹é‡ç”Ÿæˆåœºæ™¯å›¾ç‰‡ | `sceneId`, `mode`, `gridSize`, `prompt`, `force` |
| `batchGenerateProjectImages` | æ‰¹é‡ç”Ÿæˆé¡¹ç›®å›¾ç‰‡ | `mode`, `gridSize`, `prompt`, `force` |
| `generateSceneVideo` | ç”Ÿæˆåœºæ™¯ Sora è§†é¢‘ | `sceneId` |
| `generateShotsVideo` | ç”ŸæˆæŒ‡å®šåˆ†é•œ Sora è§†é¢‘ | `sceneId`, `shotIds`, `shotIndexes`, `globalShotIndexes` |
| `batchGenerateProjectVideosSora` | æ‰¹é‡ç”Ÿæˆ Sora è§†é¢‘ | `force` |
| `generateCharacterThreeView` | ç”Ÿæˆè§’è‰²ä¸‰è§†å›¾ | `characterId`, `prompt`, `artStyle` |

---

## ğŸ¥ Sora è§†é¢‘ç”Ÿæˆæ¶æ„

### æ ¸å¿ƒæµç¨‹

1. **è§’è‰²æ³¨å†Œ** â†’ 2. **åœºæ™¯æ‹†åˆ†** â†’ 3. **Prompt ç»„è£…** â†’ 4. **ä»»åŠ¡æäº¤** â†’ 5. **çŠ¶æ€è½®è¯¢** â†’ 6. **R2 æŒä¹…åŒ–**

### å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|------|------|
| **åŠ¨æ€æ¯”ä¾‹åŒè½¨åˆ¶** | è§’è‰²æ³¨å†Œè·Ÿéšæºå›¾æ¯”ä¾‹ï¼Œæ­£ç‰‡ç”Ÿæˆè·Ÿéšé¡¹ç›®è®¾ç½® |
| **ç²¾ç®€ JSON åè®®** | `@username` ä½œä¸ºè§’è‰²å”¯ä¸€ Keyï¼ŒåºŸå¼ƒå†—ä½™ä¸­æ–‡å |
| **æ™ºèƒ½æ‹†åˆ†** | >15s åœºæ™¯è‡ªåŠ¨æ‹†åˆ†ä¸ºå¤šæ®µä»»åŠ¡ (Greedy Packing) |
| **ç»Ÿä¸€è´¨é‡æ§åˆ¶** | é€šè¿‡ `global_prompt` åœ¨è„šæœ¬å±‚çº§è¿½åŠ ä¸€æ¬¡åç¼€ |
| **Fire-and-Forget** | åå°å¼‚æ­¥æ³¨å†Œè§’è‰² (æ³¨æ„ï¼šServerless ç¯å¢ƒä¸‹å¤±æ•ˆ) |
| **å¤šé•œå¤´ä»»åŠ¡æ˜ å°„** | `sora_tasks.shot_ids / shot_ranges` è®°å½•è¦†ç›–åˆ†é•œï¼Œç”¨äºæ—¶é—´è½´åˆå¹¶æ˜¾ç¤º |

### è¯¦ç»†æ–‡æ¡£
- `docs/sora åœ¨æœ¬é¡¹ç›®ä¸­çš„æ¶æ„.md` - Sora é›†æˆå®Œæ•´æŠ€æœ¯æ–‡æ¡£

---

## ğŸ“ é¡¹ç›®ç»“æ„é€ŸæŸ¥

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ agent/              # Agent å¯¹è¯
â”‚   â”‚   â”œâ”€â”€ sora/               # Sora ç›¸å…³ (generate, status, character/)
â”‚   â”‚   â”œâ”€â”€ gemini-*/           # Gemini å„åŠŸèƒ½ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ seedream*/          # SeeDream å›¾ç‰‡ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ admin/              # ç®¡ç†åå° API
â”‚   â”‚   â””â”€â”€ supabase/           # ç»Ÿä¸€æ•°æ®åº“ç½‘å…³
â”‚   â”œâ”€â”€ admin/                  # ç®¡ç†åå°é¡µé¢
â”‚   â””â”€â”€ (main)/                 # ä¸»åº”ç”¨é¡µé¢
â”œâ”€â”€ components/                 # UI ç»„ä»¶
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ credits.ts              # ç§¯åˆ†é…ç½®
â”‚   â””â”€â”€ users.ts                # ç®¡ç†å‘˜åå•
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useAgent.ts             # Agent Hook (å«é˜²é‡å¤æäº¤)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ dataService.ts          # ç»Ÿä¸€æ•°æ®æœåŠ¡å±‚
â”‚   â”œâ”€â”€ storageService.ts       # R2 å­˜å‚¨æœåŠ¡
â”‚   â”œâ”€â”€ auth-middleware.ts      # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ supabase/               # Supabase å®¢æˆ·ç«¯
â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚ (è§ä¸Šæ–¹è¡¨æ ¼)
â”œâ”€â”€ store/
â”‚   â””â”€â”€ useProjectStore.ts      # Zustand çŠ¶æ€ç®¡ç†
â””â”€â”€ types/                      # TypeScript ç±»å‹å®šä¹‰
```

---

## ğŸ”‘ æ ¸å¿ƒå¼€å‘è§„èŒƒ

### æ•°æ®æ“ä½œ

```typescript
// âœ… æ­£ç¡®ï¼šç»Ÿä¸€æ•°æ®å±‚ï¼Œè‡ªåŠ¨å¤„ç†äº‘ç«¯/æœ¬åœ°åŒæ­¥
import { dataService } from '@/lib/dataService';
await dataService.saveProject(project);

// âŒ é”™è¯¯ï¼šä¸è¦ç›´æ¥è°ƒç”¨åº•å±‚å®¢æˆ·ç«¯
import { supabase } from '@/lib/supabase/client';
```

### è®¤è¯ä¸­é—´ä»¶

```typescript
// æ‰€æœ‰ AI API è·¯ç”±å¿…é¡»è°ƒç”¨ authenticateRequest
const authResult = await authenticateRequest(request);
if ('error' in authResult) return authResult.error;

// è‡ªåŠ¨æ‰§è¡Œï¼šJWT éªŒè¯ â†’ Profile åˆ›å»º â†’ ç™½åå•æ£€æŸ¥ â†’ é¢‘ç‡é™åˆ¶
```

### ç§¯åˆ†ç³»ç»Ÿ

```typescript
// æ¶ˆè€—æ ‡å‡† (1 ç§¯åˆ† â‰ˆ 0.1 å…ƒ)
GEMINI_GRID: 20 ç§¯åˆ†
GEMINI_IMAGE: 10 ç§¯åˆ†
GEMINI_TEXT/ANALYZE: 3 ç§¯åˆ†
SEEDREAM_GENERATE: 3 ç§¯åˆ†
VOLCANO_VIDEO: 50 ç§¯åˆ†

// è§’è‰²ç­–ç•¥
ç®¡ç†å‘˜ (Admin): å…è´¹ (ADMIN_FREE = true)
VIP ç”¨æˆ·: 8 æŠ˜ (VIP_DISCOUNT_RATE = 0.8)
```

### Agent è¯·æ±‚å–æ¶ˆ

```typescript
// Agent å¯¹è¯æ”¯æŒå–æ¶ˆï¼ˆé€šè¿‡ stop() æ–¹æ³•ï¼‰
const { stop, sendMessage } = useAgent();

// å†…éƒ¨å·²é›†æˆé˜²é‡å¤æäº¤é€»è¾‘ï¼ˆ2ç§’å†…ç›¸åŒæ¶ˆæ¯å“ˆå¸Œæ‹¦æˆªï¼‰
```

---

## âš ï¸ ä¸¥ç¦è¡Œä¸º

- âŒ **ä¸¥ç¦**åœ¨å®¢æˆ·ç«¯ç›´æ¥æš´éœ²æˆ–ä½¿ç”¨ API Key
- âŒ **ä¸¥ç¦**è·³è¿‡ç™½åå•æ£€æŸ¥ç›´æ¥è°ƒç”¨ AI æ¥å£
- âŒ **ä¸¥ç¦**ç›´æ¥ä¿®æ”¹ `project.chatHistory`ï¼ˆå·²è¿ç§»è‡³äº‘ç«¯ `chat_messages` è¡¨ï¼‰
- âŒ **ä¸¥ç¦**åœ¨è½®è¯¢ API ä¸­ä½¿ç”¨åŒæ­¥é˜»å¡ï¼ˆ`waitForCompletion` ä»…é™åç«¯é•¿æ—¶ä»»åŠ¡ï¼‰

---

## ğŸ“‹ å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|------|------|
| **å—æ§å†…æµ‹åˆ¶** | é»˜è®¤æ³¨å†Œç”¨æˆ·æ—  AI æƒé™ï¼Œéœ€ç®¡ç†å‘˜æ‰‹åŠ¨å¼€å¯ `is_whitelisted` |
| **è¯·æ±‚å¯å–æ¶ˆ** | æ‰€æœ‰é•¿è€—æ—¶ AI è¯·æ±‚å¿…é¡»æ”¯æŒ AbortSignal |
| **Grid åœºæ™¯çº§** | Grid ç”Ÿæˆæ˜¯åœºæ™¯çº§åˆ«çš„ï¼Œåˆ‡ç‰‡åæ‰‹åŠ¨åˆ†é…ç»™é•œå¤´ |
| **çŠ¶æ€è‡ªåŠ¨ä¿å­˜** | Store å˜æ›´è§¦å‘ 800ms é˜²æŠ–ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ save |
| **Serverless é™åˆ¶** | Sora é•¿æ—¶ä»»åŠ¡åœ¨ Vercel Serverless ç¯å¢ƒä¸‹ä¼šè¶…æ—¶ï¼Œéœ€å®¹å™¨åŒ–éƒ¨ç½² |

---

## ğŸ¨ Jimeng é›†æˆç»†èŠ‚

è¯¦è§é¡¹ç›®ä¸­å·²æœ‰çš„ Jimeng é›†æˆè¯´æ˜ï¼ˆé€†å‘å·¥ç¨‹è‡ª `n8n-nodes-jimeng`ï¼‰ï¼š

- **æ ¸å¿ƒä¾èµ–**: `crc-32`, `image-size`, `crypto`
- **ä¸Šä¼ æµç¨‹**: ä¸‹è½½ â†’ ç”³è¯· Token â†’ ä¸Šä¼  â†’ æäº¤ç¡®è®¤
- **Blend æ¨¡å¼**: å­˜åœ¨å‚è€ƒå›¾æ—¶å¿…é¡»ä½¿ç”¨ `blend` æ¨¡å¼
- **ç­¾åç®—æ³•**: AWS Signature Version 4 (Service: `imagex`, Region: `cn-north-1`)

---

**æœ€åæ›´æ–°**: 2025-12-26
**ç‰ˆæœ¬**: v0.6.1 (Sora Multi-Shot + Global Prompt)
