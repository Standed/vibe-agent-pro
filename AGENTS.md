# Video Agent Pro - AGENTS æŒ‡å—

AI é©±åŠ¨çš„è§†é¢‘åˆ†é•œç”Ÿæˆä¸ç¼–è¾‘å·¥å…· | Next.js 15.1 + React 19 + TypeScript 5.8

---

## ğŸš€ å¼€å‘ç¯å¢ƒæç¤º

### å¯åŠ¨ä¸æ„å»º
- **å¼€å‘æ¨¡å¼**: `npm run dev` (å¯åŠ¨ Turbopackï¼Œæ”¯æŒçƒ­é‡è½½ï¼Œç«¯å£ 3000)
- **âš ï¸ ä¸è¦åœ¨å¼€å‘æ—¶è¿è¡Œ `npm run build`** - è¿™ä¼šåˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ï¼Œç ´åçƒ­é‡è½½
- **ç”Ÿäº§æ„å»º**: `npm run build` (ä»…åœ¨éœ€è¦éƒ¨ç½²æˆ–ç±»å‹æ£€æŸ¥æ—¶è¿è¡Œ)
- **ä»£ç æ£€æŸ¥**: `npm run lint` (ESLint è§„åˆ™æ£€æŸ¥)

---

## ğŸ› æ ¸å¿ƒæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚ (Frontend)                              â”‚
â”‚   React 19 + Zustand + Tailwind CSS                                  â”‚
â”‚   useProjectStore (çŠ¶æ€ç®¡ç†) + useAgent (AI äº¤äº’)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API è·¯ç”±å±‚ (API Routes)                       â”‚
â”‚   Next.js App Router (src/app/api/)                                   â”‚
â”‚   è®¤è¯ä¸­é—´ä»¶ (auth-middleware.ts) + ç»Ÿä¸€ç½‘å…³ (supabase/)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æœåŠ¡å±‚ (Services)                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚AgentService  â”‚  â”‚GeminiService â”‚  â”‚VolcanoEngineService  â”‚       â”‚
â”‚   â”‚ (AI æ¨ç†)    â”‚  â”‚ (å›¾ç‰‡ç”Ÿæˆ)   â”‚  â”‚  (SeeDream/SeeDance) â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚SoraOrchestratorâ”‚ â”‚KaponaiServiceâ”‚ â”‚JimengService         â”‚       â”‚
â”‚   â”‚ (è§†é¢‘ç¼–æ’)    â”‚  â”‚ (Sora API)   â”‚  â”‚  (å³æ¢¦é›†æˆ)          â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å±‚ (Data Layer)                           â”‚
â”‚   dataService.ts (ç»Ÿä¸€æ•°æ®æœåŠ¡)                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚    Supabase PostgreSQL  â”‚       â”‚    Cloudflare R2         â”‚     â”‚
â”‚   â”‚    (ç»“æ„åŒ–æ•°æ® + URL)   â”‚       â”‚   (åª’ä½“æ–‡ä»¶å­˜å‚¨)          â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæœåŠ¡æ–‡ä»¶æ¸…å•

| æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| **Agent æ ¸å¿ƒ** | `src/services/agentService.ts` | AI Agent æ¨ç†ã€Function Calling |
| **Agent å·¥å…·æ‰§è¡Œ** | `src/services/agentTools.ts` | å·¥å…·å®é™…æ‰§è¡Œé€»è¾‘ |
| **å·¥å…·å®šä¹‰** | `src/services/agentToolDefinitions.ts` | å·¥å…· JSON Schema (å®¢æˆ·ç«¯å®‰å…¨) |
| **Gemini æœåŠ¡** | `src/services/geminiService.ts` | Grid å¤šè§†å›¾ç”Ÿæˆã€å›¾ç‰‡åˆ†æ |
| **ç«å±±å¼•æ“æœåŠ¡** | `src/services/volcanoEngineService.ts` | SeeDream å›¾ç‰‡ã€SeeDance è§†é¢‘ |
| **Sora ç¼–æ’å™¨** | `src/services/SoraOrchestrator.ts` | Sora è§†é¢‘ç”Ÿæˆå…¨æµç¨‹ç¼–æ’ (æ”¯æŒå¹¶è¡Œæäº¤) |
| **Sora ä»»åŠ¡ç®¡ç†** | `src/hooks/useSoraTaskManager.ts` | ç»Ÿä¸€ä»»åŠ¡ç®¡ç† (æ™ºèƒ½æ’åºã€é˜²è¦†ç›–åŒæ­¥) |
| **Kaponai æœåŠ¡** | `src/services/KaponaiService.ts` | Sora API åº•å±‚å°è£… |
| **è§’è‰²ä¸€è‡´æ€§** | `src/services/CharacterConsistencyService.ts` | è§’è‰²æ³¨å†Œä¸å‚è€ƒè§†é¢‘ç”Ÿæˆ |
| **Sora Prompt** | `src/services/SoraPromptService.ts` | Sora ä¸“ç”¨æç¤ºè¯ç”Ÿæˆ |
| **åˆ†é•œæ¿æœåŠ¡** | `src/services/StoryboardService.ts` | å‰§æœ¬è§£æä¸åˆ†é•œç”Ÿæˆ |
| **å³æ¢¦æœåŠ¡** | `src/services/jimengService.ts` | å³æ¢¦ API é›†æˆ |
| **å¹¶è¡Œæ‰§è¡Œå™¨** | `src/services/parallelExecutor.ts` | å·¥å…·å¹¶è¡Œæ‰§è¡Œï¼Œè¿›åº¦è¿½è¸ª |
| **ä¸Šä¸‹æ–‡æ„å»º** | `src/services/contextBuilder.ts` | å¢å¼ºä¸Šä¸‹æ–‡é¢„æ³¨å…¥ |
| **ç»Ÿä¸€æ•°æ®æœåŠ¡** | `src/lib/dataService.ts` | æ‰€æœ‰æ•°æ® CRUD æ“ä½œç»Ÿä¸€å…¥å£ |
| **å­˜å‚¨æœåŠ¡** | `src/lib/storageService.ts` | R2 æ–‡ä»¶ä¸Šä¼ /ç®¡ç† |
| **è®¤è¯ä¸­é—´ä»¶** | `src/lib/auth-middleware.ts` | JWT éªŒè¯ã€ç™½åå•æ£€æŸ¥ã€ç§¯åˆ†æ¶ˆè€— |

---

## ğŸ” è®¤è¯ä¸æˆæƒ

> âš ï¸ **é‡è¦**: æœ¬é¡¹ç›®**ä¸æ”¯æŒæ¸¸å®¢æ¨¡å¼**ï¼Œæ‰€æœ‰åŠŸèƒ½å¿…é¡»ç™»å½•åä½¿ç”¨ã€‚

### è®¤è¯æµç¨‹

```typescript
// æ‰€æœ‰ AI API è·¯ç”±å¿…é¡»è°ƒç”¨ authenticateRequest
const authResult = await authenticateRequest(request);
if ('error' in authResult) return authResult.error;

// è‡ªåŠ¨æ‰§è¡Œï¼šJWT éªŒè¯ â†’ Profile åˆ›å»º â†’ ç™½åå•æ£€æŸ¥ â†’ é¢‘ç‡é™åˆ¶
```

### è§’è‰²ç³»ç»Ÿ

| è§’è‰² | è¯´æ˜ | ç§¯åˆ†ç­–ç•¥ |
|------|------|----------|
| **Admin** | ç®¡ç†å‘˜ | å…è´¹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ (`ADMIN_FREE = true`) |
| **VIP** | VIP ç”¨æˆ· | 8 æŠ˜ä¼˜æƒ  (`VIP_DISCOUNT_RATE = 0.8`) |
| **User** | æ™®é€šç”¨æˆ· | æ ‡å‡†ç§¯åˆ†æ¶ˆè€— |

### ç§¯åˆ†æ¶ˆè€—æ ‡å‡† (1 ç§¯åˆ† â‰ˆ 0.1 å…ƒ)

```typescript
GEMINI_GRID: 20 ç§¯åˆ†      // Grid å¤šè§†å›¾ç”Ÿæˆ
GEMINI_IMAGE: 10 ç§¯åˆ†     // Gemini å•å›¾
GEMINI_TEXT/ANALYZE: 3 ç§¯åˆ†
SEEDREAM_GENERATE: 3 ç§¯åˆ†
VOLCANO_VIDEO: 50 ç§¯åˆ†
```

---

## ğŸ¤– Agent å·¥å…·åˆ—è¡¨

Agent é€šè¿‡ Function Calling è°ƒç”¨ä»¥ä¸‹å·¥å…·æ“ä½œé¡¹ç›®ï¼ˆå…± 28 ä¸ªå·¥å…·ï¼‰ï¼š

### æŸ¥è¯¢ç±»å·¥å…·

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `getProjectContext` | è·å–é¡¹ç›®å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯ | - |
| `getSceneDetails` | è·å–åœºæ™¯è¯¦æƒ… | `sceneId` |
| `getShotDetails` | è·å–åˆ†é•œè¯¦æƒ… | `shotId` |
| `searchScenes` | æœç´¢åœºæ™¯ | `query` |

### åˆ›å»º/æ›´æ–°ç±»å·¥å…·

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `createScene` | åˆ›å»ºæ–°åœºæ™¯ | `name`, `description` |
| `updateScene` | æ›´æ–°åœºæ™¯ä¿¡æ¯ | `sceneId`, `updates` |
| `addShots` | æ·»åŠ åˆ†é•œ | `sceneId`, `count`, `shots[]` |
| `updateShot` | æ›´æ–°åˆ†é•œä¿¡æ¯ | `shotId`, `updates` |
| `addCharacter` | æ·»åŠ æ–°è§’è‰² | `name`, `description`, `appearance` |
| `updateCharacter` | æ›´æ–°è§’è‰²ä¿¡æ¯ | `characterId`, `updates` |
| `addLocation` | æ·»åŠ æ–°åœ°ç‚¹ | `name`, `description` |
| `updateLocation` | æ›´æ–°åœ°ç‚¹ä¿¡æ¯ | `locationId`, `updates` |

### åˆ é™¤ç±»å·¥å…·

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `deleteScene` | åˆ é™¤å•ä¸ªåœºæ™¯ | `sceneId` |
| `deleteScenes` | æ‰¹é‡åˆ é™¤åœºæ™¯ | `sceneIds[]`, `sceneIndexes[]`, `deleteDuplicates` |
| `deleteShot` | åˆ é™¤å•ä¸ªåˆ†é•œ | `shotId` |
| `deleteShots` | æ‰¹é‡åˆ é™¤åˆ†é•œ | `shotIds[]`, `shotIndexes[]`, `deleteDuplicates` |
| `deleteCharacter` | åˆ é™¤å•ä¸ªè§’è‰² | `characterId` |
| `deleteCharacters` | æ‰¹é‡åˆ é™¤è§’è‰² | `characterIds[]`, `characterNames[]` |
| `deleteLocations` | æ‰¹é‡åˆ é™¤åœ°ç‚¹ | `locationIds[]`, `locationNames[]` |

### å›¾ç‰‡ç”Ÿæˆå·¥å…·

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `generateShotImage` | ç”Ÿæˆå•ä¸ªåˆ†é•œå›¾ç‰‡ | `shotId`, `mode (seedream/gemini/grid)`, `gridSize`, `force` |
| `batchGenerateSceneImages` | æ‰¹é‡ç”Ÿæˆåœºæ™¯å›¾ç‰‡ | `sceneId`, `mode`, `gridSize`, `force` |
| `batchGenerateProjectImages` | æ‰¹é‡ç”Ÿæˆé¡¹ç›®å›¾ç‰‡ | `mode`, `gridSize`, `force` |
| `generateCharacterThreeView` | ç”Ÿæˆè§’è‰²ä¸‰è§†å›¾ | `characterId`, `prompt`, `artStyle` |
| `generateLocationImages` | æ‰¹é‡ç”Ÿæˆåœ°ç‚¹å‚è€ƒå›¾ | `locationIds[]`, `model (jimeng/gemini)` |

### è§†é¢‘ç”Ÿæˆå·¥å…· (Sora)

| å·¥å…·å | æè¿° | å…³é”®å‚æ•° |
|--------|------|----------|
| `generateSceneVideo` | ç”Ÿæˆåœºæ™¯ Sora è§†é¢‘ | `sceneId` |
| `generateShotsVideo` | ç”ŸæˆæŒ‡å®šåˆ†é•œ Sora è§†é¢‘ | `sceneId`, `shotIds[]`, `shotIndexes[]`, `globalShotIndexes[]` |
| `batchGenerateProjectVideosSora` | æ‰¹é‡ç”Ÿæˆ Sora è§†é¢‘ | `force` |

---

## ğŸ¥ Sora è§†é¢‘ç”Ÿæˆæ¶æ„

### æ ¸å¿ƒæµç¨‹

```
1. è§’è‰²æ³¨å†Œ â†’ 2. åœºæ™¯æ‹†åˆ† â†’ 3. Prompt ç»„è£… â†’ 4. ä»»åŠ¡æäº¤ â†’ 5. çŠ¶æ€è½®è¯¢ â†’ 6. R2 æŒä¹…åŒ–
```

### å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|------|------|
| **åŠ¨æ€æ¯”ä¾‹åŒè½¨åˆ¶** | è§’è‰²æ³¨å†Œè·Ÿéšæºå›¾æ¯”ä¾‹ï¼Œæ­£ç‰‡ç”Ÿæˆè·Ÿéšé¡¹ç›®è®¾ç½® |
| **ç²¾ç®€ JSON åè®®** | `@username` ä½œä¸ºè§’è‰²å”¯ä¸€ Keyï¼ŒåºŸå¼ƒå†—ä½™ä¸­æ–‡å |
| **æ™ºèƒ½æ‹†åˆ†** | >15s åœºæ™¯è‡ªåŠ¨æ‹†åˆ†ä¸ºå¤šæ®µä»»åŠ¡ (Greedy Packing) |
| **å¹¶è¡Œä»»åŠ¡æäº¤** | è·¨åœºæ™¯/å¤šé•œå¤´ä»»åŠ¡ä½¿ç”¨ `Promise.all` å¹¶è¡Œæäº¤ |
| **æ™ºèƒ½è‡ªåŠ¨åŒæ­¥** | ä»»åŠ¡å®Œæˆåè‡ªåŠ¨åŒæ­¥åˆ°åˆ†é•œï¼Œå…·å¤‡**é˜²è¦†ç›–æœºåˆ¶** |
| **Timeline è”åŠ¨** | è¿›åº¦æ¡æ‹–æ‹½æ”¯æŒè‡ªåŠ¨åˆ‡é•œï¼Œæ’­æ”¾çŠ¶æ€ä¸¥æ ¼åŒæ­¥ |
| **å¤šé•œå¤´ä»»åŠ¡æ˜ å°„** | `sora_tasks.shot_ids` è®°å½•è¦†ç›–åˆ†é•œï¼Œæ”¯æŒå•ä»»åŠ¡å¯¹åº”å¤šé•œå¤´ |

### è¯¦ç»†æ–‡æ¡£
- `docs/sora åœ¨æœ¬é¡¹ç›®ä¸­çš„æ¶æ„.md` - Sora é›†æˆå®Œæ•´æŠ€æœ¯æ–‡æ¡£

---

## ï¿½ é¡¹ç›®ç»“æ„é€ŸæŸ¥

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”± (22+ ç«¯ç‚¹)
â”‚   â”‚   â”œâ”€â”€ agent/              # Agent å¯¹è¯
â”‚   â”‚   â”œâ”€â”€ sora/               # Sora ç›¸å…³ (10 ä¸ªå­ç«¯ç‚¹)
â”‚   â”‚   â”œâ”€â”€ gemini-*/           # Gemini å„åŠŸèƒ½ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ jimeng/             # å³æ¢¦å›¾ç‰‡ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ seedream*/          # SeeDream å›¾ç‰‡ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ admin/              # ç®¡ç†åå° API
â”‚   â”‚   â”œâ”€â”€ upload-r2/          # R2 æ–‡ä»¶ä¸Šä¼ 
â”‚   â”‚   â””â”€â”€ supabase/           # ç»Ÿä¸€æ•°æ®åº“ç½‘å…³
â”‚   â”œâ”€â”€ admin/                  # ç®¡ç†åå°é¡µé¢
â”‚   â”œâ”€â”€ auth/                   # è®¤è¯é¡µé¢ (ç™»å½•/æ³¨å†Œ)
â”‚   â””â”€â”€ project/[id]/           # é¡¹ç›®ç¼–è¾‘é¡µ
â”œâ”€â”€ components/                 # UI ç»„ä»¶ (18 ä¸ªç›®å½•)
â”‚   â”œâ”€â”€ agent/                  # Agent ç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ auth/                   # è®¤è¯ç»„ä»¶ (AuthProvider)
â”‚   â”œâ”€â”€ canvas/                 # æ— é™ç”»å¸ƒ
â”‚   â”œâ”€â”€ chat/                   # èŠå¤©ç•Œé¢
â”‚   â”œâ”€â”€ layout/                 # å¸ƒå±€ç»„ä»¶ (ä¾§è¾¹æ ã€é¢æ¿ç­‰)
â”‚   â”œâ”€â”€ pro/                    # Pro æ¨¡å¼ç»„ä»¶
â”‚   â”œâ”€â”€ shot/                   # åˆ†é•œç›¸å…³ç»„ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ credits.ts              # ç§¯åˆ†é…ç½®
â”‚   â””â”€â”€ users.ts                # ç®¡ç†å‘˜åå•
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAgent.ts             # Agent Hook (å«é˜²é‡å¤æäº¤)
â”‚   â”œâ”€â”€ useSoraTaskManager.ts   # Sora ä»»åŠ¡ç®¡ç†
â”‚   â””â”€â”€ useAIStoryboard.ts      # AI åˆ†é•œç”Ÿæˆ
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ dataService.ts          # ç»Ÿä¸€æ•°æ®æœåŠ¡å±‚ (1269 è¡Œ)
â”‚   â”œâ”€â”€ storageService.ts       # R2 å­˜å‚¨æœåŠ¡
â”‚   â”œâ”€â”€ auth-middleware.ts      # è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ api-client.ts           # è®¤è¯è¯·æ±‚å®¢æˆ·ç«¯
â”‚   â””â”€â”€ supabase/               # Supabase å®¢æˆ·ç«¯é…ç½®
â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚ (19+ æ–‡ä»¶)
â”‚   â”œâ”€â”€ agentService.ts         # Agent æ ¸å¿ƒ (976 è¡Œ)
â”‚   â”œâ”€â”€ agentToolDefinitions.ts # å·¥å…·å®šä¹‰ (28 ä¸ªå·¥å…·)
â”‚   â”œâ”€â”€ SoraOrchestrator.ts     # Sora ç¼–æ’å™¨ (723 è¡Œ)
â”‚   â””â”€â”€ tools/                  # å·¥å…·å®ç° (7 ä¸ªæ–‡ä»¶)
â”œâ”€â”€ store/
â”‚   â””â”€â”€ useProjectStore.ts      # Zustand çŠ¶æ€ç®¡ç† (674 è¡Œ)
â””â”€â”€ types/                      # TypeScript ç±»å‹å®šä¹‰
    â””â”€â”€ project.ts              # é¡¹ç›®æ•°æ®æ¨¡å‹ (512 è¡Œ)
```

---

## ğŸ’¾ æ•°æ®å­˜å‚¨æ¶æ„

### æ ¸å¿ƒåŸåˆ™

> âš ï¸ **Supabase ç»å¯¹ä¸å­˜å‚¨åª’ä½“æ–‡ä»¶æœ¬èº«ï¼Œåªå­˜å‚¨ URL å¼•ç”¨ï¼**

```
âœ… æ­£ç¡®ï¼šSupabase åªå­˜å‚¨ Cloudflare R2 çš„è®¿é—® URLï¼ˆTEXT ç±»å‹ï¼‰
âŒ é”™è¯¯ï¼šSupabase å­˜å‚¨å›¾ç‰‡/è§†é¢‘/éŸ³é¢‘çš„äºŒè¿›åˆ¶æ•°æ®æˆ– Base64
```

### å­˜å‚¨åˆ†å·¥

| å­˜å‚¨ | ç”¨é€” | å†…å®¹ |
|------|------|------|
| **Supabase PostgreSQL** | ç»“æ„åŒ–æ•°æ® | ç”¨æˆ·ã€é¡¹ç›®ã€åœºæ™¯ã€åˆ†é•œã€èŠå¤©å†å²ã€ç§¯åˆ†è®°å½• |
| **Cloudflare R2** | åª’ä½“æ–‡ä»¶ | å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€Grid åˆ‡ç‰‡ |

### æ•°æ®è¡¨æ¦‚è§ˆ

- `profiles` - ç”¨æˆ·ä¿¡æ¯ã€ç§¯åˆ†ä½™é¢ã€è§’è‰²
- `projects` - é¡¹ç›®å…ƒæ•°æ®
- `scenes` - åœºæ™¯æ•°æ®
- `shots` - åˆ†é•œæ•°æ®
- `characters` - è§’è‰²æ•°æ® (æ”¯æŒå…¨å±€è§’è‰²)
- `audio_assets` - éŸ³é¢‘èµ„æº
- `chat_messages` - AI å¯¹è¯å†å² (ä¸‰çº§å±‚çº§: project/scene/shot)
- `sora_tasks` - Sora ä»»åŠ¡çŠ¶æ€
- `series` - å‰§é›†ç®¡ç†

---

## ğŸ”‘ æ ¸å¿ƒå¼€å‘è§„èŒƒ

### æ•°æ®æ“ä½œ

```typescript
// âœ… æ­£ç¡®ï¼šç»Ÿä¸€æ•°æ®å±‚ï¼Œè‡ªåŠ¨å¤„ç†äº‘ç«¯åŒæ­¥
import { dataService } from '@/lib/dataService';
await dataService.saveProject(project);

// âŒ é”™è¯¯ï¼šä¸è¦ç›´æ¥è°ƒç”¨åº•å±‚å®¢æˆ·ç«¯
import { supabase } from '@/lib/supabase/client';
```

### Agent è¯·æ±‚å–æ¶ˆ

```typescript
// Agent å¯¹è¯æ”¯æŒå–æ¶ˆï¼ˆé€šè¿‡ stop() æ–¹æ³•ï¼‰
const { stop, sendMessage } = useAgent();

// å†…éƒ¨å·²é›†æˆé˜²é‡å¤æäº¤é€»è¾‘ï¼ˆ2ç§’å†…ç›¸åŒæ¶ˆæ¯å“ˆå¸Œæ‹¦æˆªï¼‰
```

### å·¥å…·å¹¶è¡Œæ‰§è¡Œ

```typescript
// ä½¿ç”¨ ParallelExecutor æ‰§è¡Œå·¥å…·è°ƒç”¨
import { ParallelExecutor } from '@/services/parallelExecutor';
const executor = new ParallelExecutor(project, storeCallbacks, onProgress, userId);
const results = await executor.execute(toolCalls);
```

---

## âš ï¸ ä¸¥ç¦è¡Œä¸º

- âŒ **ä¸¥ç¦**åœ¨å®¢æˆ·ç«¯ç›´æ¥æš´éœ²æˆ–ä½¿ç”¨ API Key
- âŒ **ä¸¥ç¦**è·³è¿‡ç™½åå•æ£€æŸ¥ç›´æ¥è°ƒç”¨ AI æ¥å£
- âŒ **ä¸¥ç¦**ç›´æ¥ä¿®æ”¹ `project.chatHistory`ï¼ˆå·²è¿ç§»è‡³äº‘ç«¯ `chat_messages` è¡¨ï¼‰
- âŒ **ä¸¥ç¦**åœ¨è½®è¯¢ API ä¸­ä½¿ç”¨åŒæ­¥é˜»å¡ï¼ˆ`waitForCompletion` ä»…é™åç«¯é•¿æ—¶ä»»åŠ¡ï¼‰
- âŒ **ä¸¥ç¦**å­˜å‚¨ Base64 å›¾ç‰‡åˆ° Supabaseï¼ˆå¿…é¡»ä¸Šä¼  R2 åå­˜å‚¨ URLï¼‰

---

## ğŸ“‹ å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|------|------|
| **çº¯äº‘ç«¯å­˜å‚¨** | ä¸å†æ”¯æŒæ¸¸å®¢æ¨¡å¼/æœ¬åœ°å­˜å‚¨ï¼Œæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ Supabase |
| **å—æ§å†…æµ‹åˆ¶** | é»˜è®¤æ³¨å†Œç”¨æˆ·æ—  AI æƒé™ï¼Œéœ€ç®¡ç†å‘˜æ‰‹åŠ¨å¼€å¯ `is_whitelisted` |
| **è¯·æ±‚å¯å–æ¶ˆ** | æ‰€æœ‰é•¿è€—æ—¶ AI è¯·æ±‚å¿…é¡»æ”¯æŒ AbortSignal |
| **Grid åœºæ™¯çº§** | Grid ç”Ÿæˆæ˜¯åœºæ™¯çº§åˆ«çš„ï¼Œåˆ‡ç‰‡åæ‰‹åŠ¨åˆ†é…ç»™é•œå¤´ |
| **çŠ¶æ€è‡ªåŠ¨ä¿å­˜** | Store å˜æ›´è§¦å‘ 800ms é˜²æŠ–ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ save |
| **Serverless é™åˆ¶** | Sora é•¿æ—¶ä»»åŠ¡åœ¨ Vercel Serverless ç¯å¢ƒä¸‹ä¼šè¶…æ—¶ï¼Œéœ€å®¹å™¨åŒ–éƒ¨ç½² |
| **Planning æ¨¡å¼é™åˆ¶** | Planning é¢‘é“ç¦æ­¢è°ƒç”¨å›¾ç‰‡/è§†é¢‘ç”Ÿæˆå·¥å…·ï¼Œé¿å…æå‰æ¶ˆè€—èµ„æº |

---

## ğŸ”„ AI æ¨¡å‹é›†æˆ

| æ¨¡å‹ | ç”¨é€” | æœåŠ¡æ–‡ä»¶ |
|------|------|----------|
| **Gemini 3 Flash** | Agent æ¨ç†ã€Grid å¤šè§†å›¾ç”Ÿæˆã€å›¾ç‰‡åˆ†æ | `geminiService.ts` |
| **ç«å±±å¼•æ“ SeeDream** | é«˜è´¨é‡å›¾ç‰‡ç”Ÿæˆ | `volcanoEngineService.ts` |
| **ç«å±±å¼•æ“ SeeDance** | å›¾ç”Ÿè§†é¢‘ | `volcanoEngineService.ts` |
| **Sora 2 (Kaponai)** | ä¸“ä¸šè§†é¢‘ç”Ÿæˆã€è§’è‰²ä¸€è‡´æ€§ | `KaponaiService.ts`, `SoraOrchestrator.ts` |
| **å³æ¢¦ (Jimeng)** | ä¸­æ–‡ä¼˜åŒ–çš„å›¾åƒç”Ÿæˆ | `jimengService.ts` |

---

## ğŸ¨ Jimeng é›†æˆç»†èŠ‚

è¯¦è§é¡¹ç›®ä¸­å·²æœ‰çš„ Jimeng é›†æˆè¯´æ˜ï¼ˆé€†å‘å·¥ç¨‹è‡ª `n8n-nodes-jimeng`ï¼‰ï¼š

- **æ ¸å¿ƒä¾èµ–**: `crc-32`, `image-size`, `crypto`
- **ä¸Šä¼ æµç¨‹**: ä¸‹è½½ â†’ ç”³è¯· Token â†’ ä¸Šä¼  â†’ æäº¤ç¡®è®¤
- **Blend æ¨¡å¼**: å­˜åœ¨å‚è€ƒå›¾æ—¶å¿…é¡»ä½¿ç”¨ `blend` æ¨¡å¼
- **ç­¾åç®—æ³•**: AWS Signature Version 4 (Service: `imagex`, Region: `cn-north-1`)

---

**æœ€åæ›´æ–°**: 2026-01-19  
**ç‰ˆæœ¬**: v3.0 (çº¯äº‘ç«¯æ¶æ„ + å®Œæ•´å·¥å…·é“¾)
